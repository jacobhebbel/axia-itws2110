<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Axia - Stock Data Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <img src="./images/logo.png" alt="Axia Logo" class="logo">
        <img src="./images/name.png" alt="Axia - Smart Finance, Simple Solutions" class="title-img">
    </header>

    <!-- <div class="ticker-container">
        <div class="ticker" id="live-ticker">
             all of the ticker tape stuff is poplated by javascript-- need to find more efficient alternative here or get rid of it
        </div>
    </div>  -->

    <!-- for the data table with the P/E, volitility, yield, EPS, and price range-->
    <div class="dashboard">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title" id="card-title-1">Stock Metrics Comparison</h2>
                <div class="stock-selector">
                    <select class="stock-select" id="stock-select-1">
                        <option value="AAPL">Apple (AAPL)</option>
                        <option value="MSFT">Microsoft (MSFT)</option>
                        <option value="GOOGL">Alphabet (GOOGL)</option>
                        <option value="AMZN">Amazon (AMZN)</option>
                        <option value="TSLA">Tesla (TSLA)</option>
                        <option value="AVGO">Broadcom (AVGO)</option>
                    </select>
                    <select class="stock-select" id="display-select-1">
                        <option value="data-table">Data Table</option>
                        <option value="efficient-frontier">Efficient Frontier</option>
                        <option value="total-risk">Total Risk Contribution</option>
                        <option value="mctr">MCTR Pie Chart</option>
                    </select>
                </div>
            </div>
            <div class="loader" id="metrics-loader"></div>
            
            <!-- Data Table (default) -->
            <div id="data-table-container">
                <table class="stats-table" id="metrics-table">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Current</th>
                            <th>Market Expectation</th>
                            <th>Market Average</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- data populated by javascript -->
                    </tbody>
                </table>
            </div>
            
            <!-- Chart Containers (hidden by default) -->
            <div class="chart-container" id="chart-container-1" style="display: none;">
                <canvas id="chart-1"></canvas>
            </div>
            
            <div class="status-indicator" id="data-status">
                <span class="status-dot status-live"></span>
                <span>Live Market Data</span>
            </div>
        </div>

        <!-- everything here is for the efficient frontier graph that clark wanted us to add -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title" id="card-title-2">CRSP Efficient Frontier</h2>
                <div class="stock-selector">
                    <!-- Stock selector (hidden by default for efficient frontier) -->
                    <select class="stock-select" id="stock-select-2" style="display: none;">
                        <option value="AAPL">Apple (AAPL)</option>
                        <option value="MSFT">Microsoft (MSFT)</option>
                        <option value="GOOGL">Alphabet (GOOGL)</option>
                        <option value="AMZN">Amazon (AMZN)</option>
                        <option value="TSLA">Tesla (TSLA)</option>
                        <option value="AVGO">Broadcom (AVGO)</option>
                    </select>
                    <!-- Cap selector (shown by default for efficient frontier) -->
                    <select class="stock-select" id="frontier-select">
                        <option value="large_cap">Large Cap Stocks</option>
                        <option value="mid_cap">Mid Cap Stocks</option>
                        <option value="small_cap">Small Cap Stocks</option>
                    </select>
                    <select class="stock-select" id="display-select-2">
                        <option value="efficient-frontier">Efficient Frontier</option>
                        <option value="data-table">Data Table</option>
                        <option value="total-risk">Total Risk Contribution</option>
                        <option value="mctr">MCTR Pie Chart</option>
                    </select>
                </div>
            </div>
            
            <!-- Chart Containers -->
            <div class="chart-container" id="chart-container-2">
                <canvas id="chart-2"></canvas>
            </div>
            
            <!-- Data Table (hidden by default) -->
            <div id="data-table-container-2" style="display: none;">
                <table class="stats-table" id="metrics-table-2">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Current</th>
                            <th>Market Expectation</th>
                            <th>Market Average</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- data populated by javascript -->
                    </tbody>
                </table>
            </div>
            
            <div class="frontier-legend" id="frontier-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #edd39a;"></div>
                    <span>Efficient Frontier</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4caf50;"></div>
                    <span>Optimal Portfolio</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #f44336;"></div>
                    <span>Individual Assets</span>
                </div>
                <div class="legend-item">
                    <div class="line-legend" style="background-color: #9C27B0;"></div>
                    <span>Capital Market Line</span>
                </div>
                <div class="legend-item">
                    <div class="line-legend" style="background-color: #2196F3;"></div>
                    <span>Equal Weight Portfolio</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Chart instances
        let chart1 = null;
        let chart2 = null;

        // Your original API configuration and functions
        const ALPHA_VANTAGE_BASE_URL = 'https://www.alphavantage.co/query';
        const ALPHA_VANTAGE_API_KEY = 'DHGUBI4YDAV44GOY'; 
        const YAHOO_FINANCE_BASE_URL = 'https://query1.finance.yahoo.com/v8/finance/chart';

        // Market hours configuration
        const MARKET_OPEN_HOUR = 9;
        const MARKET_CLOSE_HOUR = 16;
        const MARKET_DAYS = [1, 2, 3, 4, 5]; 

        const metricsLoader = document.getElementById('metrics-loader');
        const metricsTable = document.getElementById('metrics-table');
        const liveTicker = document.getElementById('live-ticker');
        const dataStatus = document.getElementById('data-status');

        // Function to see if market is open
        function isMarketOpen() {
            const now = new Date();
            const utcHours = now.getUTCHours();
            const utcDay = now.getUTCDay();
            const estHours = (utcHours - 4 + 24) % 24; 
            if (!MARKET_DAYS.includes(utcDay)) return false;
            return (estHours > MARKET_OPEN_HOUR || (estHours === MARKET_OPEN_HOUR && now.getUTCMinutes() >= 30)) && 
                   estHours < MARKET_CLOSE_HOUR;
        }

        // Status indicator function
        function updateDataStatus() {
            const isOpen = isMarketOpen();
            const statusDot = dataStatus.querySelector('.status-dot');
            const statusText = dataStatus.querySelector('span:last-child');
            
            if (isOpen) {
                statusDot.className = 'status-dot status-live';
                statusText.textContent = 'Live Market Data';
            } else {
                statusDot.className = 'status-dot status-delayed';
                statusText.textContent = 'Delayed Data (Previous Close)';
            }
        }

        // Your original efficient frontier data generation
        function generateEfficientFrontierData(type) {
            const frontierData = [];
            const individualAssets = [];
            const capitalMarketLine = [];
            const equalWeightLine = [];
            
            let baseReturn, baseRisk, riskFreeRate;
            switch(type) {
                case 'large_cap':
                    baseReturn = 0.08;
                    baseRisk = 0.15;
                    riskFreeRate = 0.02;
                    break;
                case 'mid_cap':
                    baseReturn = 0.10;
                    baseRisk = 0.18;
                    riskFreeRate = 0.02;
                    break;
                case 'small_cap':
                    baseReturn = 0.12;
                    baseRisk = 0.22;
                    riskFreeRate = 0.02;
                    break;
                default:
                    baseReturn = 0.08;
                    baseRisk = 0.15;
                    riskFreeRate = 0.02;
            }
            
            for (let i = 0; i <= 20; i++) {
                const risk = baseRisk + (i * 0.01);
                const returnVal = baseReturn + 0.4 * Math.pow(risk - baseRisk, 0.7);
                frontierData.push({x: risk, y: returnVal});
            }
            
            const optimalRisk = baseRisk + 0.08;
            const optimalReturn = baseReturn + 0.06;
            
            for (let i = 0; i <= 10; i++) {
                const t = i / 10;
                const risk = t * optimalRisk;
                const returnVal = riskFreeRate + t * (optimalReturn - riskFreeRate);
                capitalMarketLine.push({x: risk, y: returnVal});
            }
            
            const equalWeightReturn = baseReturn + 0.02;
            for (let i = 0; i <= 20; i++) {
                const risk = baseRisk + (i * 0.01);
                equalWeightLine.push({x: risk, y: equalWeightReturn});
            }
            
            for (let i = 0; i < 15; i++) {
                const risk = baseRisk + (Math.random() * 0.15);
                const returnVal = baseReturn + (Math.random() * 0.1) - 0.05;
                individualAssets.push({x: risk, y: returnVal});
            }
            
            const optimalPortfolio = {x: optimalRisk, y: optimalReturn};
            
            return { frontierData, individualAssets, optimalPortfolio, capitalMarketLine, equalWeightLine, riskFreeRate };
        }

        // Your original stock data fetching functions
        async function fetchStockData(symbol) {
            try {
                metricsLoader.style.display = 'block';
                metricsTable.style.opacity = '0.5';
                
                const url = `${ALPHA_VANTAGE_BASE_URL}?function=OVERVIEW&symbol=${symbol}&apikey=${ALPHA_VANTAGE_API_KEY}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.Note || data.Information) {
                    throw new Error('API rate limit exceeded. Please try again later.');
                }
                
                return data;
            } catch (error) {
                console.error('Error fetching stock data:', error);
                return await fetchStockDataFromYahoo(symbol);
            } finally {
                metricsLoader.style.display = 'none';
                metricsTable.style.opacity = '1';
            }
        }

        async function fetchStockDataFromYahoo(symbol) {
            try {
                const url = `${YAHOO_FINANCE_BASE_URL}/${symbol}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Yahoo Finance API error: ${response.status}`);
                }
                
                const data = await response.json();
                const result = data.chart.result[0];
                
                return {
                    Symbol: symbol,
                    Name: result.meta.symbol,
                    PERatio: result.meta.trailingPE || 'N/A',
                    DividendYield: result.meta.trailingAnnualDividendYield ? 
                        (result.meta.trailingAnnualDividendYield * 100).toFixed(2) + '%' : 'N/A'
                };
            } catch (error) {
                console.error('Error fetching from Yahoo Finance:', error);
                return generateMockData(symbol);
            }
        }

        function generateMockData(symbol) {
            const mockData = {
                AAPL: {
                    Symbol: 'AAPL',
                    Name: 'Apple Inc.',
                    PERatio: '39.91',
                    DividendYield: '0.40%',
                    EPS: '6.59',
                    Beta: '1.09',
                    '52WeekHigh': '169.21',
                    '52WeekLow': '265.29'
                },
                MSFT: {
                    Symbol: 'MSFT',
                    Name: 'Microsoft Corporation',
                    PERatio: '38.45',
                    DividendYield: '0.70%',
                    EPS: '13.64',
                    Beta: '1.02',
                    '52WeekHigh': '555.45',
                    '52WeekLow': '344.79'
                },
                GOOGL: {
                    Symbol: 'GOOGL',
                    Name: 'Alphabet Inc.',
                    PERatio: '27.88',
                    DividendYield: '0.33%',
                    EPS: '9.39',
                    Beta: '1.00',
                    '52WeekHigh': '262.51',
                    '52WeekLow': '142.66'
                },
                AMZN: {
                    Symbol: 'AMZN',
                    Name: 'Amazon.com Inc.',
                    PERatio: '34.25',
                    DividendYield: 'N/A',
                    EPS: '6.57',
                    Beta: '1.28',
                    '52WeekHigh': '242.52',
                    '52WeekLow': '161.38'
                },
                TSLA: {
                    Symbol: 'TSLA',
                    Name: 'Tesla Inc.',
                    PERatio: '76.3',
                    DividendYield: 'N/A',
                    EPS: '3.1',
                    Beta: '2.0',
                    '52WeekHigh': '299.29',
                    '52WeekLow': '152.37'
                },
                AVGO: {
                    Symbol: 'AVGO',
                    Name: 'Broadcom Inc.',
                    PERatio: '91.45',
                    DividendYield: 'N/A',
                    EPS: '1.44',
                    Beta: '2.09',
                    '52WeekHigh': '488.54',
                    '52WeekLow': '214.25'
                }
            };
            
            return mockData[symbol] || mockData.AAPL;
        }

        // Your original stock metrics update function - FIXED
        async function updateStockMetrics() {
            const symbol = document.getElementById('stock-select-1').value;
            const data = await fetchStockData(symbol);
            
            const tableBody = metricsTable.querySelector('tbody');
            
            // Format the data table exactly as in your original code
            tableBody.innerHTML = `
                <tr>
                    <td>P/E Ratio</td>
                    <td class="${data.PERatio && parseFloat(data.PERatio) < 25 ? 'good-value' : 'bad-value'}">${data.PERatio || 'N/A'}</td>
                    <td>${data.PERatio && !isNaN(parseFloat(data.PERatio)) ? (parseFloat(data.PERatio) + 2).toFixed(1) : 'N/A'}</td>
                    <td>22.1</td>
                </tr>
                <tr>
                    <td>Volatility (Beta)</td>
                    <td class="${data.Beta && parseFloat(data.Beta) < 1 ? 'good-value' : 'bad-value'}">${data.Beta || 'N/A'}</td>
                    <td>${data.Beta && !isNaN(parseFloat(data.Beta)) ? (parseFloat(data.Beta) - 0.1).toFixed(1) : 'N/A'}</td>
                    <td>1.0</td>
                </tr>
                <tr>
                    <td>Dividend Yield</td>
                    <td class="${data.DividendYield && data.DividendYield !== 'N/A' && parseFloat(data.DividendYield) > 0.5 ? 'good-value' : 'bad-value'}">${data.DividendYield || 'N/A'}</td>
                    <td>${data.DividendYield || 'N/A'}</td>
                    <td>2.1%</td>
                </tr>
                <tr>
                    <td>EPS</td>
                    <td class="${data.EPS && parseFloat(data.EPS) > 5 ? 'good-value' : 'bad-value'}">${data.EPS || 'N/A'}</td>
                    <td>${data.EPS && !isNaN(parseFloat(data.EPS)) ? (parseFloat(data.EPS) - 0.5).toFixed(2) : 'N/A'}</td>
                    <td>8.7</td>
                </tr>
                <tr>
                    <td>52W Range</td>
                    <td class="${(data['52WeekHigh'] && data['52WeekLow'] && (parseFloat(data['52WeekHigh']) - parseFloat(data['52WeekLow'])) / parseFloat(data['52WeekLow']) < 0.5 ? 'good-value' : 'bad-value')}">
                        ${data['52WeekLow'] || 'N/A'} - ${data['52WeekHigh'] || 'N/A'}
                    </td>
                    <td>N/A</td>
                    <td>40-60%</td>
                </tr>
            `;

            // Update the card title
            document.getElementById('card-title-1').textContent = `${data.Name || symbol} Metrics`;
        }

        // Function to update card title based on selection
        function updateCardTitle(displaySelectId, cardTitleId, defaultTitle) {
            const displaySelect = document.getElementById(displaySelectId);
            const cardTitle = document.getElementById(cardTitleId);
            const selectedValue = displaySelect.value;
            
            const titleMap = {
                'data-table': 'Stock Metrics Comparison',
                'efficient-frontier': 'CRSP Efficient Frontier',
                'total-risk': 'Total Risk Contribution',
                'mctr': 'Marginal Contribution to Risk'
            };
            
            cardTitle.textContent = titleMap[selectedValue] || defaultTitle;
        }

        // Function to update dropdown visibility based on selection
        function updateDropdownVisibility(displaySelectId, stockSelectId, frontierSelectId) {
            const displaySelect = document.getElementById(displaySelectId);
            const stockSelect = document.getElementById(stockSelectId);
            const frontierSelect = document.getElementById(frontierSelectId);
            
            const selectedValue = displaySelect.value;
            
            if (selectedValue === 'efficient-frontier') {
                // Show cap selector, hide stock selector for efficient frontier
                if (stockSelect) stockSelect.style.display = 'none';
                if (frontierSelect) frontierSelect.style.display = 'block';
            } else {
                // Show stock selector, hide cap selector for other options
                if (stockSelect) stockSelect.style.display = 'block';
                if (frontierSelect) frontierSelect.style.display = 'none';
            }
        }

        // Function to show/hide containers based on selection
        function updateDisplay(containerId, displaySelectId, chartId, isFirstCard = true) {
            const displaySelect = document.getElementById(displaySelectId);
            const chartContainer = document.getElementById(`chart-container-${containerId}`);
            const dataTableContainer = document.getElementById(isFirstCard ? 'data-table-container' : `data-table-container-${containerId}`);
            const frontierLegend = document.getElementById('frontier-legend');
            const chartCanvas = document.getElementById(`chart-${chartId}`);
            
            // Update card title first
            updateCardTitle(displaySelectId, `card-title-${containerId}`, 
                           isFirstCard ? 'Stock Metrics Comparison' : 'CRSP Efficient Frontier');
            
            // Update dropdown visibility
            if (isFirstCard) {
                updateDropdownVisibility(displaySelectId, 'stock-select-1', null);
            } else {
                updateDropdownVisibility(displaySelectId, 'stock-select-2', 'frontier-select');
            }
            
            // Hide everything first
            if (chartContainer) chartContainer.style.display = 'none';
            if (dataTableContainer) dataTableContainer.style.display = 'none';
            if (frontierLegend) frontierLegend.style.display = 'none';
            
            // Show selected display
            const selectedValue = displaySelect.value;
            
            if (selectedValue === 'data-table') {
                if (dataTableContainer) {
                    dataTableContainer.style.display = 'block';
                    if (!isFirstCard) {
                        updateSecondaryDataTable();
                    }
                }
            } else {
                if (chartContainer) {
                    chartContainer.style.display = 'block';
                    if (frontierLegend && selectedValue === 'efficient-frontier') {
                        frontierLegend.style.display = 'flex';
                    }
                    
                    // Destroy existing chart if it exists
                    const chartToDestroy = chartId === '1' ? chart1 : chart2;
                    if (chartToDestroy) {
                        chartToDestroy.destroy();
                    }
                    
                    // Create new chart based on selection
                    const ctx = chartCanvas.getContext('2d');
                    let newChart;
                    
                    switch(selectedValue) {
                        case 'efficient-frontier':
                            newChart = createEfficientFrontierChart(ctx);
                            break;
                        case 'total-risk':
                            newChart = createTotalRiskChart(ctx);
                            break;
                        case 'mctr':
                            newChart = createMCTRChart(ctx);
                            break;
                    }
                    
                    // Store reference to the chart
                    if (chartId === '1') {
                        chart1 = newChart;
                    } else {
                        chart2 = newChart;
                    }
                }
            }
        }

        // Function to create Efficient Frontier Chart
        function createEfficientFrontierChart(ctx) {
            const { frontierData, individualAssets, optimalPortfolio, capitalMarketLine, equalWeightLine } = generateEfficientFrontierData('large_cap');
            
            return new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Capital Market Line',
                            data: capitalMarketLine,
                            borderColor: '#9C27B0',
                            backgroundColor: 'rgba(156, 39, 176, 0.1)',
                            borderWidth: 2,
                            showLine: true,
                            fill: false,
                            pointRadius: 0,
                            borderDash: [5, 5]
                        },
                        {
                            label: 'Equal Weight Portfolio',
                            data: equalWeightLine,
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            borderWidth: 1,
                            showLine: true,
                            fill: false,
                            pointRadius: 0,
                            borderDash: [2, 2]
                        },
                        {
                            label: 'Efficient Frontier',
                            data: frontierData,
                            borderColor: '#edd39a',
                            backgroundColor: 'rgba(237, 211, 154, 0.1)',
                            borderWidth: 3,
                            showLine: true,
                            fill: false,
                            pointRadius: 0,
                            tension: 0.2
                        },
                        {
                            label: 'Optimal Portfolio',
                            data: [optimalPortfolio],
                            backgroundColor: '#4caf50',
                            borderColor: '#4caf50',
                            pointRadius: 8,
                            pointHoverRadius: 10
                        },
                        {
                            label: 'Individual Assets',
                            data: individualAssets,
                            backgroundColor: '#f44336',
                            borderColor: '#f44336',
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Risk (Standard Deviation)',
                                color: '#ddd'
                            },
                            ticks: {
                                color: '#ddd',
                                callback: function(value) {
                                    return (value * 100).toFixed(0) + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            min: 0.1,
                            max: 0.35
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Expected Return',
                                color: '#ddd'
                            },
                            ticks: {
                                color: '#ddd',
                                callback: function(value) {
                                    return (value * 100).toFixed(0) + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            min: 0.0,
                            max: 0.2
                        }
                    },
                    plugins: {
                        legend: {
                            display: false,
                            labels: {
                                color: '#ddd'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    const datasetLabel = context.dataset.label || '';
                                    
                                    if (datasetLabel === 'Efficient Frontier') {
                                        return `Frontier: ${(point.y * 100).toFixed(1)}% return, ${(point.x * 100).toFixed(1)}% risk`;
                                    } else if (datasetLabel === 'Optimal Portfolio') {
                                        return `Optimal: ${(point.y * 100).toFixed(1)}% return, ${(point.x * 100).toFixed(1)}% risk`;
                                    } else if (datasetLabel === 'Capital Market Line') {
                                        return `CML: ${(point.y * 100).toFixed(1)}% return, ${(point.x * 100).toFixed(1)}% risk`;
                                    } else if (datasetLabel === 'Equal Weight Portfolio') {
                                        return `Equal Weight: ${(point.y * 100).toFixed(1)}% return`;
                                    } else {
                                        return `Asset: ${(point.y * 100).toFixed(1)}% return, ${(point.x * 100).toFixed(1)}% risk`;
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        // Function to create Total Risk Contribution Chart
        function createTotalRiskChart(ctx) {
            // For first card, use stock-select-1; for second card, use stock-select-2
            const stockSelectId = ctx.canvas.id === 'chart-1' ? 'stock-select-1' : 'stock-select-2';
            const currentStock = document.getElementById(stockSelectId).value;
            const stockData = getCurrentStockData(currentStock);
            
            const high = parseFloat(stockData['52WeekHigh']) || 0;
            const low = parseFloat(stockData['52WeekLow']) || 0;
            const currentPrice = (high + low) / 2;
            const volatility = high > 0 ? ((high - low) / currentPrice * 100).toFixed(1) : 25;
            
            const totalRiskData = {
                labels: ['Current Stock', 'Market Average'],
                datasets: [{
                    label: 'Total Risk Contribution (%)',
                    data: [
                        parseFloat(volatility),
                        15
                    ],
                    backgroundColor: ['#2196F3', '#9C27B0'],
                    borderColor: ['#2196F3', '#9C27B0'],
                    borderWidth: 1
                }]
            };
            
            return new Chart(ctx, {
                type: 'bar',
                data: totalRiskData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'category',
                            position: 'bottom',
                            ticks: {
                                color: '#ddd'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Risk Contribution (%)',
                                color: '#ddd'
                            },
                            ticks: {
                                color: '#ddd',
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ddd'
                            }
                        }
                    }
                }
            });
        }

        // Function to create MCTR Pie Chart
        function createMCTRChart(ctx) {
            // For first card, use stock-select-1; for second card, use stock-select-2
            const stockSelectId = ctx.canvas.id === 'chart-1' ? 'stock-select-1' : 'stock-select-2';
            const currentStock = document.getElementById(stockSelectId).value;
            const stockData = getCurrentStockData(currentStock);
            
            const peRatio = parseFloat(stockData.PERatio) || 25;
            const beta = parseFloat(stockData.Beta) || 1.0;
            const high = parseFloat(stockData['52WeekHigh']) || 0;
            const low = parseFloat(stockData['52WeekLow']) || 0;
            const currentPrice = (high + low) / 2;
            const volatility = high > 0 ? ((high - low) / currentPrice) : 0.25;
            
            const mctrValue = Math.min(95, Math.max(5, (beta * 30 + volatility * 40 + (peRatio > 30 ? 20 : 10))));
            const remainingRisk = 100 - mctrValue;
            
            const mctrData = {
                labels: [currentStock + ' MCTR', 'Portfolio Residual Risk'],
                datasets: [{
                    data: [mctrValue, remainingRisk],
                    backgroundColor: ['#edd39a', '#4caf50'],
                    borderColor: ['#edd39a', '#4caf50'],
                    borderWidth: 2
                }]
            };
            
            return new Chart(ctx, {
                type: 'pie',
                data: mctrData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#ddd',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw;
                                    return `${label}: ${value}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Helper function to get current stock data
        function getCurrentStockData(symbol) {
            return generateMockData(symbol);
        }

        // Function to update secondary data table
        function updateSecondaryDataTable() {
            const symbol = document.getElementById('stock-select-2').value;
            const tableBody = document.querySelector('#metrics-table-2 tbody');
            
            tableBody.innerHTML = document.querySelector('#metrics-table tbody').innerHTML;
        }

        // Add event listeners for dropdowns
        document.getElementById('display-select-1').addEventListener('change', function() {
            updateDisplay('1', 'display-select-1', '1', true);
        });

        document.getElementById('display-select-2').addEventListener('change', function() {
            updateDisplay('2', 'display-select-2', '2', false);
        });

        // Update the stock selection event listeners to handle both selectors
        document.getElementById('stock-select-1').addEventListener('change', function() {
            updateStockMetrics();
            
            // Refresh charts if they're showing stock-specific data
            if (chart1 && document.getElementById('display-select-1').value !== 'efficient-frontier' && 
                document.getElementById('display-select-1').value !== 'data-table') {
                updateDisplay('1', 'display-select-1', '1', true);
            }
        });

        document.getElementById('stock-select-2').addEventListener('change', function() {
            // Refresh charts if they're showing stock-specific data in the second card
            if (chart2 && document.getElementById('display-select-2').value !== 'efficient-frontier' && 
                document.getElementById('display-select-2').value !== 'data-table') {
                updateDisplay('2', 'display-select-2', '2', false);
            }
        });

        // Update frontier chart when cap selection changes
        document.getElementById('frontier-select').addEventListener('change', function() {
            if (chart2 && document.getElementById('display-select-2').value === 'efficient-frontier') {
                const newData = generateEfficientFrontierData(this.value);
                
                chart2.data.datasets[0].data = newData.capitalMarketLine;
                chart2.data.datasets[1].data = newData.equalWeightLine;
                chart2.data.datasets[2].data = newData.frontierData;
                chart2.data.datasets[3].data = [newData.optimalPortfolio];
                chart2.data.datasets[4].data = newData.individualAssets;
                
                chart2.update();
            }
        });

        // Initialize everything on page load
        document.addEventListener('DOMContentLoaded', () => {
            updateDataStatus();
            updateStockMetrics(); // This will populate the data table on load
            updateTickerData();
            
            // Initialize dropdown visibility
            updateDropdownVisibility('display-select-1', 'stock-select-1', null);
            updateDropdownVisibility('display-select-2', 'stock-select-2', 'frontier-select');
            
            // Initialize the efficient frontier chart
            const frontierCtx = document.getElementById('chart-2').getContext('2d');
            const { frontierData, individualAssets, optimalPortfolio, capitalMarketLine, equalWeightLine } = generateEfficientFrontierData('large_cap');
            chart2 = new Chart(frontierCtx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Capital Market Line',
                            data: capitalMarketLine,
                            borderColor: '#9C27B0',
                            backgroundColor: 'rgba(156, 39, 176, 0.1)',
                            borderWidth: 2,
                            showLine: true,
                            fill: false,
                            pointRadius: 0,
                            borderDash: [5, 5]
                        },
                        {
                            label: 'Equal Weight Portfolio',
                            data: equalWeightLine,
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            borderWidth: 1,
                            showLine: true,
                            fill: false,
                            pointRadius: 0,
                            borderDash: [2, 2]
                        },
                        {
                            label: 'Efficient Frontier',
                            data: frontierData,
                            borderColor: '#edd39a',
                            backgroundColor: 'rgba(237, 211, 154, 0.1)',
                            borderWidth: 3,
                            showLine: true,
                            fill: false,
                            pointRadius: 0,
                            tension: 0.2
                        },
                        {
                            label: 'Optimal Portfolio',
                            data: [optimalPortfolio],
                            backgroundColor: '#4caf50',
                            borderColor: '#4caf50',
                            pointRadius: 8,
                            pointHoverRadius: 10
                        },
                        {
                            label: 'Individual Assets',
                            data: individualAssets,
                            backgroundColor: '#f44336',
                            borderColor: '#f44336',
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: 'Risk (Standard Deviation)',
                                color: '#ddd'
                            },
                            ticks: {
                                color: '#ddd',
                                callback: function(value) {
                                    return (value * 100).toFixed(0) + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            min: 0.1,
                            max: 0.35
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Expected Return',
                                color: '#ddd'
                            },
                            ticks: {
                                color: '#ddd',
                                callback: function(value) {
                                    return (value * 100).toFixed(0) + '%';
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            min: 0.0,
                            max: 0.2
                        }
                    },
                    plugins: {
                        legend: {
                            display: false,
                            labels: {
                                color: '#ddd'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const point = context.raw;
                                    const datasetLabel = context.dataset.label || '';
                                    
                                    if (datasetLabel === 'Efficient Frontier') {
                                        return `Frontier: ${(point.y * 100).toFixed(1)}% return, ${(point.x * 100).toFixed(1)}% risk`;
                                    } else if (datasetLabel === 'Optimal Portfolio') {
                                        return `Optimal: ${(point.y * 100).toFixed(1)}% return, ${(point.x * 100).toFixed(1)}% risk`;
                                    } else if (datasetLabel === 'Capital Market Line') {
                                        return `CML: ${(point.y * 100).toFixed(1)}% return, ${(point.x * 100).toFixed(1)}% risk`;
                                    } else if (datasetLabel === 'Equal Weight Portfolio') {
                                        return `Equal Weight: ${(point.y * 100).toFixed(1)}% return`;
                                    } else {
                                        return `Asset: ${(point.y * 100).toFixed(1)}% return, ${(point.x * 100).toFixed(1)}% risk`;
                                    }
                                }
                            }
                        }
                    }
                }
            });
            
            setInterval(() => {
                updateDataStatus();
                updateTickerData();
            }, 60000);
        });

        async function updateTickerData() {
        }
    </script>
</body>
</html>